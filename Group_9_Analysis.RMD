---
title: "Group_9_Analysis"
author: "Brent Strong, Enyu Li, Haotian Wang, Honjin Ren, Mu He"
date: "3/7/2022"
output: pdf_document
---

```{r libraries, echo = FALSE}
#Load necessary libraries for the data exploration and analysis
library(tidyverse)
library(moderndive)
library(skimr)
library(kableExtra)
library(gridExtra)
library(broom)
library(olsrr)
library(gapminder)
library(sjPlot)
library(stats)
library(jtools)
library(MASS)
library(janitor)
library(ggplot2)
library(caret)
```

```{r import, echo = FALSE}
#Read in data from github and abbreviate certain country names.
analysis <- read_csv("https://raw.githubusercontent.com/brent-strong/DAS2022-Group-09/main/dataset9.csv")
glimpse(analysis)
for(i in 1:nrow(analysis)){
  if(str_detect(analysis$country_of_origin[i], "Puerto Rico")){
    analysis$country_of_origin[i] <- "Puerto Rico"
  }
  if(str_detect(analysis$country_of_origin[i], "Hawaii")){
    analysis$country_of_origin[i] <- "Hawaii"
  }
  if(str_detect(analysis$country_of_origin[i], "Tanzania")){
    analysis$country_of_origin[i] <- "Tanzania"
  }
  else{
    analysis$country_of_origin[i] <- analysis$country_of_origin[i]
  }
}
# View(analysis)
```







```{r boxplots, echo = FALSE}
# glimpse(analysis)

# Create the final data set. Remove observations that have implausible values for at least one of the variables. Standardize aroma, flavor, acidity, and altitude. Apply a log(x+1) transformation to category_two_defects variable. Turn Qualityclass into an indicator variable so that it can be used in the logistic regression analysis. Remove unneeded variables.

coffee_final <- analysis %>%
  filter(acidity != 0 & altitude_mean_meters < 8849 & !is.na(harvested)) %>%
  mutate(aroma = as.numeric(scale(aroma)), flavor=as.numeric(scale(flavor)), acidity=as.numeric(scale(acidity)), defects_log = log(category_two_defects + 1), altitude = as.numeric(scale(altitude_mean_meters)), year = as.factor(harvested), Qualityclass = 0 + as.numeric(Qualityclass == "Good")) 

# divide 3 levels for the altitude @hameed_coffee_2020

coffee_final$level_1 <- ifelse(coffee_final$altitude_mean_meters<900,1,0)
coffee_final$level_2 <- ifelse(coffee_final$altitude_mean_meters>=900 & coffee_final$altitude_mean_meters<=1200,1,0)
coffee_final$level_3 <- ifelse(coffee_final$altitude_mean_meters>1200,1,0)
coffee_final <- coffee_final %>%
  mutate(level = as.character(level_1 + level_2*2 + level_3*3))
  
# Finally we can get the final dataset coffee_final

coffee_final <- coffee_final %>%
  dplyr::select(country_of_origin, aroma, flavor, acidity, defects_log, year, level, Qualityclass)
  
# View the final data set and make that the standardizations and transformation were appropriately applied.

glimpse(coffee_final)

```

# Formal Analysis

## Build the models

**Only base on the altitude**
```{r}
model_level <- glm(Qualityclass ~ level - 1, data = coffee_final,family = binomial(link = "logit"))
summary(model_level)
```

**Base on the year of harvest**
```{r}
model_year <- glm(Qualityclass ~ year, data = coffee_final,family = binomial(link = "logit"))
summary(model_year)
```

**Base on the country**
```{r}
model_country <- glm(Qualityclass ~ country_of_origin, data = coffee_final,family = binomial(link = "logit"))
summary(model_country)
```

According the result before, we choose some significant country as a class variable.
```{r}
coffee_final$Colombia <- ifelse(coffee_final$country_of_origin == 'Colombia',1,0)
coffee_final$Mexico <- ifelse(coffee_final$country_of_origin == 'Mexico',1,0)
coffee_final$Honduras <- ifelse(coffee_final$country_of_origin == 'Honduras',1,0)
coffee_final$Kenya <- ifelse(coffee_final$country_of_origin == 'Kenya',1,0)
```

```{r}
model_co_4 <- glm(Qualityclass ~ Colombia + Mexico + Honduras + Kenya-1, data = coffee_final,family = binomial(link = "logit"))
summary(model_co_4)
```

**Base on the year and country**
```{r}
model_cn_ye <- glm(Qualityclass ~ country_of_origin + year, data = coffee_final,family = binomial(link = "logit"))
summary(model_cn_ye)
```

**Base on the altitude and country**
```{r,warning=FALSE}
model_al_co <- glm(Qualityclass ~ level + Colombia + Mexico + Honduras + Kenya, data = coffee_final,family = binomial(link = "logit"))
summary(model_al_co)
```


**Base on the 3**
```{r,warning=FALSE}
model_al_co <- glm(Qualityclass ~ level + country_of_origin + year - 1, data = coffee_final,family = binomial(link = "logit"))
summary(model_al_co)
```


Colombia + Mexico + Honduras + Kenya


**Consider everything**
```{r}
model_all <- glm(Qualityclass ~ aroma + flavor + acidity + country_of_origin + defects_log + level + year, data = coffee_final,family = binomial(link = "logit"))
summary(model_all)
```

```{r}
model_all_2 <- glm(Qualityclass ~ aroma + flavor + acidity + Colombia + Mexico + Honduras + Kenya + defects_log + level + year, data = coffee_final, family = binomial(link = "logit"))
summary(model_all_2)
```

```{r}
stepAIC(model_all_2, direction = 'both')
```

```{r}
model_best <- glm(Qualityclass ~ aroma + flavor + acidity + Colombia + Mexico + defects_log, data = coffee_final,family = binomial(link = "logit"))
summary(model_best)
```

```{r}
set.seed(9)
folds <- createFolds(y=coffee_final$Qualityclass, k=10)
accuracy <- as.numeric()
for(i in 1:10){
  fold_test <- coffee_final[folds[[i]],]
  fold_train <- coffee_final[-folds[[i]],]
  fold_pre <- glm(Qualityclass ~ aroma + flavor + acidity + Colombia + Mexico + defects_log,family = binomial(link = logit), data =fold_train )
  fold_predict <- predict(fold_pre,type='response',newdata=fold_test)
  fold_predict <- ifelse(fold_predict >= 0.5, 1, 0)
  accuracy[i] <- mean(fold_predict == fold_test[,8])
}
mean(accuracy)
```




